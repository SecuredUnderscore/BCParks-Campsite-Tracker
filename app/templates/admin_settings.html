{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>System Settings</h2>
    <form method="POST">
        <h3>User Account Control</h3>
        <label style="display: inline-block; margin-right: 15px;">
            <input type="checkbox" name="ALLOW_REGISTRATION" {% if settings.get('ALLOW_REGISTRATION', 'true' )=='true'
                %}checked{% endif %}>
            Allow Account Registration
        </label>

        <label style="display: inline-block;">
            <input type="checkbox" name="ALLOW_PASSWORD_RESET" {% if settings.get('ALLOW_PASSWORD_RESET', 'true'
                )=='true' %}checked{% endif %}>
            Allow Account Password Resets
        </label>
        <hr>

        <h3>System Configuration</h3>
        <label>Scan Interval (Minutes)</label>
        <input type="number" name="SCAN_INTERVAL_MINUTES" value="{{ settings.get('SCAN_INTERVAL_MINUTES', '5') }}"
            min="1">
        <small class="text-muted" style="color: green;">Updates applied automatically within 1 minute.</small>
        <hr>

        <h3>Twilio (SMS) <a href="{{ url_for('main.docs', topic='twilio') }}" target="_blank"
                style="font-size: 0.8em;">[?] How to Setup</a></h3>
        <label>Account SID</label>
        <input type="text" name="TWILIO_ACCOUNT_SID" value="{{ settings.get('TWILIO_ACCOUNT_SID', '') }}">

        <label>Auth Token</label>
        <input type="password" name="TWILIO_AUTH_TOKEN" value="{{ settings.get('TWILIO_AUTH_TOKEN', '') }}">

        <label>Verify Service SID (for OTP)</label>
        <input type="text" name="TWILIO_VERIFY_SERVICE_SID" value="{{ settings.get('TWILIO_VERIFY_SERVICE_SID', '') }}"
            placeholder="VAxxxxxxxx...">

        <label>From Number</label>
        <input type="text" name="TWILIO_FROM_NUMBER" value="{{ settings.get('TWILIO_FROM_NUMBER', '') }}"
            placeholder="+1...">

        <h3>SMS Limits</h3>
        <label style="display: inline-block;">
            <input type="checkbox" name="SMS_LIMIT_ENABLED" {% if settings.get('SMS_LIMIT_ENABLED', 'false' )=='true'
                %}checked{% endif %}>
            Enable SMS Limits per Phone Number
        </label>
        <br>
        <label>Max SMS per Number (Lifetime)</label>
        <input type="number" name="SMS_LIMIT_MAX" value="{{ settings.get('SMS_LIMIT_MAX', '0') }}" min="0">

        <h4>Reset Usage</h4>
        <div style="background: #f9f9f9; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <p style="margin-top: 0; font-size: 0.9em;">Enter a phone number to reset its usage counter to 0.</p>
            <input type="text" name="RESET_PHONE_NUMBER" placeholder="e.g. 1234567890" style="margin-bottom: 5px;">
        </div>

        <hr>

        <h3>URL Shortening</h3>
        <label style="display: inline-block;">
            <input type="checkbox" name="URL_SHORTENING_ENABLED" {% if settings.get('URL_SHORTENING_ENABLED', 'false')=='true' %}checked{% endif %}>
            Enable URL Shortening (reduces SMS length)
        </label>
        <br>
        <label>Shortening Domain</label>
        <input type="text" name="URL_SHORTENING_DOMAIN" value="{{ settings.get('URL_SHORTENING_DOMAIN', '127.0.0.1:5000') }}" placeholder="yourdomain.com or 127.0.0.1:5000">
        <small class="text-muted" style="color: #666;">Include port if needed (e.g., 127.0.0.1:5000 or example.com:8080). For production, use your public domain.</small>

        <hr>

        <h3>Email Settings <a href="{{ url_for('main.docs', topic='smtp') }}" target="_blank"
                style="font-size: 0.8em;">[?] How to Setup</a></h3>
        <label>Provider</label>
        <select name="EMAIL_PROVIDER" id="emailProvider" onchange="toggleEmailFields()"
            style="margin-bottom: 10px; padding: 5px;">
            <option value="smtp" {% if settings.get('EMAIL_PROVIDER')=='smtp' %}selected{% endif %}>SMTP (Gmail,
                Outlook, Custom)</option>
            <option value="sendgrid" {% if settings.get('EMAIL_PROVIDER')=='sendgrid' %}selected{% endif %}>Twilio
                SendGrid</option>
        </select>

        <div id="smtpFields">
            <label>SMTP Host</label>
            <input type="text" name="EMAIL_HOST" value="{{ settings.get('EMAIL_HOST', '') }}"
                placeholder="smtp.gmail.com">

            <label>SMTP Port</label>
            <input type="number" name="EMAIL_PORT" value="{{ settings.get('EMAIL_PORT', '') }}" placeholder="587">

            <label>SMTP Username</label>
            <input type="text" name="EMAIL_USER" value="{{ settings.get('EMAIL_USER', '') }}">

            <label>SMTP Password</label>
            <input type="password" name="EMAIL_PASSWORD" value="{{ settings.get('EMAIL_PASSWORD', '') }}">
        </div>

        <div id="sendgridFields" style="display: none;">
            <label>SendGrid API Key</label>
            <input type="password" name="SENDGRID_API_KEY" value="{{ settings.get('SENDGRID_API_KEY', '') }}"
                placeholder="SG.xxxxxxxx...">
        </div>

        <label>From Email</label>
        <input type="text" name="EMAIL_FROM" value="{{ settings.get('EMAIL_FROM', '') }}"
            placeholder="notifications@example.com">

        <br><br>
        <button type="submit">Save Settings</button>
    </form>

    <hr style="margin: 30px 0;">

    <h3>Database Management</h3>
    <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">

        <!-- Export -->
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; flex: 1; min-width: 250px;">
            <h4>Backup</h4>
            <p>Download a copy of the current database.</p>
            <a href="{{ url_for('main.export_db') }}" class="button"
                style="text-decoration: none; background-color: #007bff; color: white; padding: 8px 15px; border-radius: 4px; display: inline-block;">Export
                Database</a>
        </div>

        <!-- Import -->
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; flex: 1; min-width: 250px;">
            <h4>Restore</h4>
            <p style="color: #dc3545; font-weight: bold; margin-bottom: 5px;">Warning: This will overwrite all data!</p>
            <p style="font-size: 0.9em; margin-bottom: 15px;">Your current admin login will be preserved.</p>
            <form action="{{ url_for('main.import_db') }}" method="POST" enctype="multipart/form-data"
                onsubmit="return confirm('WARNING: This will overwrite the ENTIRE database (alerts, users, etc) with the uploaded file.\n\nOnly your current admin login will be preserved.\n\nAre you sure you want to proceed?');">
                <input type="file" name="db_file" accept=".sqlite3,.db" required
                    style="margin-bottom: 10px; width: 100%;">
                <button type="submit"
                    style="background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Import
                    & Overwrite</button>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleEmailFields() {
        const provider = document.getElementById('emailProvider').value;
        document.getElementById('smtpFields').style.display = provider === 'smtp' ? 'block' : 'none';
        document.getElementById('sendgridFields').style.display = provider === 'sendgrid' ? 'block' : 'none';
    }
    // Init
    toggleEmailFields();
</script>
{% endblock %}