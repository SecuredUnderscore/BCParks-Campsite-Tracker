{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Communication Settings</h2>
    <p>Manage your notification methods here.</p>

    <h3>Add Contact Method</h3>
    <form method="POST" style="margin-bottom: 2rem;" id="add-contact-form">
        <input type="hidden" name="action" value="add_contact">
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <select name="method_type" id="method-type-select"
                    style="padding: 10px; min-width: 120px; font-size: 16px;" onchange="updateFormInputs()">
                    <option value="email">Email</option>
                    <option value="sms">SMS (Phone)</option>
                </select>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; gap: 5px;">
                <input type="text" name="value" id="contact-value-input" placeholder="Enter email" required
                    style="padding: 10px; min-width: 250px; font-size: 16px;">
                <small id="input-hint" style="color: #666; font-size: 0.9em; display: none;"></small>
            </div>
            <button type="submit" style="padding: 10px 20px; font-size: 16px; height: 42px;">Add</button>
        </div>
    </form>

    <script>
        function updateFormInputs() {
            const typeSelect = document.getElementById('method-type-select');
            const input = document.getElementById('contact-value-input');
            const hint = document.getElementById('input-hint');

            if (typeSelect.value === 'sms') {
                input.placeholder = "e.g., 1234567890 or +15551234567";
                // Regex: Exact 10 digits OR starting with + followed by 10 or more digits
                input.pattern = "(\\d{10}|\\+\\d{10,})";
                input.title = "Please enter exactly 10 digits, or if using a country code (other than +1 default assumption), start with + followed by the number.";

                hint.innerText = "Format: 10 digits (1234567890) OR international format (+12345678901)";
                hint.style.display = 'block';
            } else {
                input.placeholder = "Enter email";
                input.removeAttribute('pattern');
                input.removeAttribute('title');
                hint.style.display = 'none';
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', updateFormInputs);
    </script>

    <h3>Your Contact Methods</h3>
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Value</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for contact in contacts %}
                <tr>
                    <td>{{ contact.method_type|upper }}</td>
                    <td>{{ contact.value }}</td>
                    <td>
                        {% if contact.method_type == 'sms' %}
                        {% if contact.is_verified %}
                        <span style="color: green; font-weight: bold;">Verified</span>

                        {% if sms_limit_enabled %}
                        <div style="font-size: 0.85em; color: #555; margin-top: 4px;">
                            Usage: {{ contact.sms_count or 0 }} / {{ sms_limit_max }}
                        </div>
                        {% endif %}

                        {% else %}
                        <span style="color: red;">Not Verified</span>
                        <button onclick="startVerify('{{ contact.value }}')"
                            style="background-color: green; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-left: 10px;">Verify
                            Now</button>
                        {% endif %}
                        {% else %}
                        <span style="color: gray;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" style="display: inline;">
                            <input type="hidden" name="action" value="delete_contact">
                            <input type="hidden" name="contact_id" value="{{ contact.id }}">
                            <button type="submit" class="danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">No contact methods configured.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    async function startVerify(phone) {
        if (!confirm("Send verification code to " + phone + "?")) return;

        try {
            const res = await fetch('/api/verify_phone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'start', phone: phone })
            });
            const data = await res.json();

            if (data.success) {
                const code = prompt("Enter the verification code sent to your phone:");
                if (code) {
                    const res2 = await fetch('/api/verify_phone', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'check', phone: phone, code: code })
                    });
                    const data2 = await res2.json();
                    if (data2.success) {
                        alert("Phone verified successfully!");
                        location.reload();
                    } else {
                        alert("Verification failed: " + (data2.message || 'Unknown error'));
                    }
                }
            } else {
                alert("Error sending code: " + (data.message || data.error || 'Check server logs'));
            }
        } catch (e) {
            alert("Request failed: " + e);
        }
    }
</script>
{% endblock %}